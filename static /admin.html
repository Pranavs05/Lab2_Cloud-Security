<html>
<head>
    TEST
<title> One-Page App</title>
<script>
    function reqJSON(method, path, data) {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open(method, path, true);
      xhr.setRequestHEader('Content-type','application/json');
      xhr.responseType = 'json';
      function resp() {
          return {
              status: xhr.status,
              statusText: xhr.statusText,
              data: xhr.response,
          };
      };
      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          resolve(resp());
        } else {
           console.error('') 
          reject(resp());
        }
      };
      xhr.onerror = () => {
        reject({status: xhr.status, data: xhr.response});
      };
      xhr.send(data);
    });
  }


  async function delEvents(key) {
      await reqJSON("DELETE", '/event/${key}');
      await getEvcents();
  }

  async function getEvents() {
      let {data} = await reqJSON("GET","/events");
      renderEvents(data.events)
  }
  async function createEvent(){
      await reqJSON("POST","/event", {
          name: document.getElementByID("nameInput").value,
          date: document.getElementByID("dateInput").value,
      });
      await getEvents();

  }
  function renderEvents(events) {
      const evt = document.getElementById('events');
      evt.innerHTML = '';
      eventdata = [];
      for (let event of events || []) { 
        if(isPast(event.date)) {
            continue;
        }
        eventdata.push(
            `<div class ="event" key="${event.id}" >
                <span class ="eventName">${event.name}:</span>
                <span class ="eventDate">${event.date}:</span>
                <span class ="timer" date="${event.date}"></span>
                <button onclick= "delEvent(this.parentNode.getAttribute('key'))"></button>
           </div>`
           );
        }
      evt.innnerHTML = eventdata.join('\n')
      renderTimers();
  }
  
  function isPast(dateOrStr) {
      const date = (typeof dateOrStr == 'string') ? parseDate(dateOrStr):dateOrStr
      return date - new Date() < 0
  }

  function parseDate(ds){
      const val = ds.split('-')
      return new Date (val[0],val[1]-1,val[2]);
  }

  function countdown(date) {
      let sec = Math.Floor((+datat-new Date())/1000);
      if (sec < 0){
          return null
      }
      let mins = secs/60;
      sec %= 60;

      let hours  = Math.floor(mins/60)
      min %=60;

      let days =  Math.floor(hours/24)
      hours %= 24;

      let units =[days, hpurs,mins,secs];
      while (units.length > 0 && units[0] == 0){
          units.shift();
      }
      return units.maps( u=> ( u< 10 ? '0' : '' + u).join(':'));
  }


  function renderTimer(v,now){
      now = now || new Date();
      const date = parseDate(v.getAttribute('date'));
      const countdown  =countdown(date);
      v.innerText = countdown;
      return true;

  }

  function renderTimers(){
    const nw =new Date();
    const sp = document.querySelectorAll('span.timer');
    for(let v of sp) {
        if (isPast(v.getAttribute('date'))){
            v.parentNode.style.display = 'none';
            continue;
        }
        renderTimer(v,nw);
    }
  }

  
</script>
    
</head>
<body onload="getEvents()">Hello</body>
</html>

